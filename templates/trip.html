<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>snaptrip - a trip to {{ trip.trip.city.name }}</title>
  <link rel="stylesheet" href="/style/core.css" title="Main styles for this page" type="text/css" media="all"> 

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
  <script language="text/javascript" type="text/javascript">
  var page = 1;

  function loadmore() {
    page++;
    console.log("'"+page+"'");

  {% ifequal method 'machinetag' %}
    $.getJSON("/ajax/photos.more?page="+page+"&token={{ session.flickr }}&nsid={{ photos.photo.0.owner }}&tripid={{ trip.trip.id }}",
              function(json) { 
                console.log(json.photos.total);
                page = json.photos.page;
              }
             );
  {% else %}
    $.getJSON("/ajax/photos.more?page="+page+"&token={{ session.flickr }}&nsid={{ photos.photo.0.owner }}&startdate={{ trip.trip.startdate|date:"Y-m-d" }}&finishdate={{ trip.trip.finishdate|date:"Y-m-d" }}",
              function(json) { 
                console.log(json.photos.total);
                page = json.photos.page;
              }
             );
  {% endifequal %}

    return false;
  }
  </script>

</head>
<body>
  {% include "includes/header.html" %}

  <div id="content">
    <div id="main" class="trip">
      <h2>A trip to {{trip.trip.city.name}}, {{trip.trip.city.country}}.</h2>
      
      {{ session.flickr }} {{ photos.photo.0.owner }}
      
      {# TODO polyline from start point #}
      {# TODO slippymap? #}
      <p><img src="http://maps.google.com/staticmap?center={{ trip.trip.city.latitude }},{{ trip.trip.city.longitude }}&zoom=4&size=500x188&maptype=roadmap&markers={{ trip.trip.city.latitude }},{{ trip.trip.city.longitude }},smallwhite&key={{ keys.gmap }}" 
              style="border: 5px solid #{{ trip.trip.city.rgb }}; height:188px; width:500px;"></p>
    
    {% ifequal trip.trip.status "Future" %}
      <p>This trip is in the future, so no Flickr photos are available.</p>
      
    {% else %}
      {% ifnotequal trip.trip.nick session.nick %}
        <p>Unfortunately, for now we can't look up photos for other people's trips.</p>

      {% else %}
        
        {% if photos %}
        
          {% if photos.total %}
          <h3>Flickr photos from this trip.</h3>
            <div id="photos"><!-- {{ photos }} -->
            {% for photo in photos.photo %}
              <a href="http://flickr.com/photos/{{ photo.owner }}/{{ photo.id }}/" class="img"><img src="http://farm{{ photo.farm }}.static.flickr.com/{{ photo.server }}/{{ photo.id }}_{{ photo.secret }}_s.jpg" alt="{{ photo.title }}" class="{% cycle f,n,n,n,n,l %}"></a>
            {% endfor %}
        
            <p>Showing
            {% ifnotequal photos.pages 1 %}
              {{ photos.perpage }} of {{ photos.total }} photos (page {{ photos.page }} of {{ photos.pages }})
            {% else %}
              all {{ photos.total }} photos       
            {% endifnotequal %} 
          
            {% ifequal method 'machinetag' %}
              with the machine tag 'dopplr:trip={{ trip.trip.id }}'. <a href="#" onclick="javascript:return loadmore();" id="more">Load more?</a>
              
              Dopplr will use this tag to show your pubic photos, if you have associated your account.</p>
            {% else %}
              taken between {{ trip.trip.startdate|date:"d F Y" }} and {{ trip.trip.finishdate|date:"d F Y" }}. <a href="#" onclick="javascript:return loadmore();">Load more?</a></p>

    <!-- 
            <p>Tag these photos at Flickr. (Why?)</p>
     -->

            {% endifequal %}
            
            </div>
          {% else %}
            <h3>No Flickr photos found for this trip.</h3>
          {% endif %}
        {% endif %}
        
        {% if not photos %}
            <p>Please <a href="{{ url }}">authenticate with Flickr</a> to see and tag your photos from this trip.</p>
        {% endif %}
      {% endifnotequal %}
    {% endifequal %}
    
      <div id="trip_nav">
        <span class="index"><a href="/where/{{ session.nick }}">&larr; back to all trips</a></span>
        <span class="dopplr"><a href="{{ trip.trip.url }}">view this trip at Dopplr &rarr;</a></span>
      </div>
      
      <!-- {{ trip }} -->
  
    </div>

    <div id="side">
      <h3>About photos on Dopplr.</h3>
      
      <p>Dopplr's trip pages can include photos you've taken on a trip. Firstly, you'll need to <a href="http://www.dopplr.com/account/flickr">associate your Flickr and Dopplr accounts</a>. Once this is done, Dopplr will look for your photos in two ways:</p>
      
      <ul class="trip">
        <li>Using a <a href="http://www.flickr.com/groups/api/discuss/72157594497877875/">machine tag</a> for a given trip</li>
        <li>Searching on date taken</li>
      </ul>
      
      <p>snaptrip can help by making sure that your machine tags are correct, and by setting them if you don't have them already.</p>
    </div>
  </div>
  
  {% include "includes/footer.html" %}
</body>
</html>
